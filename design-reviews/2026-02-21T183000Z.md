---
type: design-review
timestamp: 2026-02-21T18:30:00Z
components: [craftstudio-ipc]
verdicts: [PASS_WITH_NOTES]
tags: [design-review, craftstudio, ipc, post-implementation]
---

# Design Review Session: 2026-02-21T18:30:00Z

**Context**: Post-implementation review of IPC unification plan (Phases 1-3). ServerBuilder, WebSocket transport, namespace routing, CraftNet adapter, frontend migration all completed.

---

## CraftStudio IPC Architecture
**Timestamp**: 2026-02-21T18:30:00Z
**Design doc**: `docs/CRAFTSTUDIO_DESIGN.md`, sections "IPC Architecture" (lines 306-341) + "Daemon Lifecycle"; `docs/CRAFTEC_ECOSYSTEM.md`, section "IPC Conventions"
**Trigger**: post-implementation ‚Äî IPC unification plan (Phases 1-3) completed, user invoked design-check
**Verdict**: PASS_WITH_NOTES

### Findings

‚úÖ MATCHES:
- `ServerBuilder` API shape (`.with_websocket()`, `.namespace()`, `.default_handler()`, `.run()`)
- `RpcRequest.id` is `serde_json::Value` (JSON-RPC 2.0 compliant ‚Äî spec allows string/number/null)
- `RpcNotification` struct has no `id` field (correct for server-push events)
- WebSocket endpoint at `ws://127.0.0.1:{port}/ws`
- API key authentication via query parameter on WebSocket
- Event broadcasting via `broadcast::Sender<String>` bridge from typed `DaemonEvent`
- Frontend `tunnelStore.ts` uses `tunnel.*` namespace prefix through `DaemonClient`
- Namespace routing correctly splits on first `.` with default handler fallback for backward compat
- Both Unix socket and WebSocket transports spawned concurrently via `tokio::select!`

‚ö†Ô∏è DEVIATIONS:
- **Builder naming**: Spec says `craftec_ipc::Server::new()` ‚Äî impl uses `ServerBuilder::new()`. Builder pattern is idiomatic Rust and arguably clearer.
- **Event format**: Spec wraps type in params `{"method":"event","params":{"type":"tunnel.state_change",...}}` ‚Äî impl emits event type directly as method `{"method":"peer_connected","params":{...}}`. Impl is more standard JSON-RPC 2.0.
- **Method naming**: Spec says `tunnel.exits` ‚Äî impl uses `tunnel.get_exits`. Extended naming for clarity.
- **Data namespace in frontend**: `DaemonClient` helper methods call `"publish"` not `"data.publish"` ‚Äî works via `default_handler` fallback, not proper namespacing.

‚ùå MISSING:
- `identity.*` namespace not registered in `daemon_manager.rs` (spec requires it)
- `settlement.*` namespace not registered (spec requires it)
- `system.*` namespace not registered (spec requires it)
- No separate `craftstudio-daemon` crate ‚Äî daemon lifecycle managed in-process by `daemon_manager.rs` inside Tauri app

üÜï EXTRA:
- `.with_api_key()` on ServerBuilder (not in original design doc ‚Äî reasonable security addition)
- Extended tunnel methods beyond spec's 4: `tunnel.get_peers`, `tunnel.start_proxy`, `tunnel.stop_proxy`, `tunnel.set_exit`, `tunnel.set_mode`, `tunnel.set_privacy`, `tunnel.history`, `tunnel.vpn_fetch`

### Disposition
- ‚ö†Ô∏è Builder naming (`Server` vs `ServerBuilder`): **ACCEPTED** ‚Äî builder pattern is idiomatic, design doc should update
- ‚ö†Ô∏è Event format: **SPEC UPDATE NEEDED** ‚Äî impl uses standard JSON-RPC notification format which is more correct
- ‚ö†Ô∏è Method naming (`tunnel.exits` vs `tunnel.get_exits`): **ACCEPTED** ‚Äî `get_` prefix consistent with other methods
- ‚ö†Ô∏è Unnamespaced data methods in frontend: **FIX NEEDED** ‚Äî should prefix with `data.*` for consistency, currently relies on default_handler
- ‚ùå Missing namespaces (identity, settlement, system): **ACCEPTED** ‚Äî handlers don't exist yet, infrastructure supports them when ready
- ‚ùå No separate daemon crate: **ACCEPTED** ‚Äî in-process daemons in Tauri avoid IPC overhead; design doc should update to reflect this deliberate choice
